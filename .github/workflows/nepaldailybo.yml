# name: Nepal Boxoffice Scraper
# 
# on:
#   schedule:
#     - cron: "0 * * * *"   # ‚è∞ every 60 minutes
#   workflow_dispatch:      # manual run
# 
# # ‚úÖ REQUIRED for git push
# permissions:
#   contents: write
#   
# # ‚úÖ Ek time pe sirf ek job chalega (no race on push)
# concurrency:
#   group: nepal-boxoffice-main
#   cancel-in-progress: false
# 
# jobs:
#   run:
#     runs-on: ubuntu-latest
# 
#     steps:
#     - name: Checkout repository
#       uses: actions/checkout@v4
#       with:
#         fetch-depth: 0  # required for rebase & push
# 
#     - name: Set up Python
#       uses: actions/setup-python@v4
#       with:
#         python-version: "3.11"
# 
#     - name: Install dependencies
#       run: |
#         pip install requests
# 
#     - name: Run Nepal Boxoffice Script
#       run: |
#         echo "üöÄ Running Nepal Boxoffice Script..."
#         python "nepaldailybo.py"
# 
#     - name: Check for changes
#       id: check_changes
#       run: |
#         if [[ -n $(git status --porcelain) ]]; then
#           echo "changes_detected=true" >> $GITHUB_ENV
#         else
#           echo "changes_detected=false" >> $GITHUB_ENV
#         fi
# 
#     - name: Commit & Push Results (with retry)
#       if: env.changes_detected == 'true'
#       run: |
#         git config --global user.name "GitHub Bot"
#         git config --global user.email "actions@github.com"
# 
#         git add .
# 
#         # safe commit (skip if nothing staged somehow)
#         git commit -m "üìä Auto-update: Nepal Boxoffice ($(date '+%d-%m-%Y %I:%M %p'))" || echo "No changes to commit"
# 
#         # ‚úÖ retry logic: pull --rebase + push (max 3 times)
#         for i in 1 2 3; do
#           echo "üîÑ Attempt $i to pull --rebase & push..."
#           if git pull --rebase && git push; then
#             echo "‚úÖ Push success on attempt $i"
#             break
#           else
#             echo "‚ö†Ô∏è Push failed on attempt $i"
#             if [ "$i" -eq 3 ]; then
#               echo "‚ùå Giving up after 3 attempts"
#               exit 1
#             fi
#             sleep 10
#           fi
#         done


name: Nepal Boxoffice Scraper + MongoDB Sync

on:
  schedule:
    - cron: "0 * * * *"   # ‚è∞ every 60 minutes
  workflow_dispatch:      # manual run

# ‚úÖ REQUIRED for git push
permissions:
  contents: write


# ‚úÖ One job at a time (no race conditions)
concurrency:
  group: nepal-boxoffice-main
  cancel-in-progress: false

jobs:
  scrape-and-sync:
    runs-on: ubuntu-latest
    timeout-minutes: 30

    steps:
    - name: üßæ Checkout repository
      uses: actions/checkout@v4
      with:
        fetch-depth: 0

    - name: üêç Set up Python
      uses: actions/setup-python@v5
      with:
        python-version: "3.11"
        cache: 'pip'

    - name: üì¶ Install scraper dependencies
      run: |
        pip install requests

    - name: üöÄ Run Nepal Boxoffice Script
      run: |
        echo "üöÄ Running Nepal Boxoffice Script..."
        python nepaldailybo.py

    - name: üîç Check for changes
      id: check_changes
      run: |
        if [[ -n $(git status --porcelain) ]]; then
          echo "changes_detected=true" >> $GITHUB_ENV
        else
          echo "changes_detected=false" >> $GITHUB_ENV
        fi

    - name: üíæ Commit & Push Results (with retry)
      if: env.changes_detected == 'true'
      run: |
        git config --global user.name "GitHub Bot"
        git config --global user.email "actions@github.com"

        git add .

        git commit -m "üìä Auto-update: Nepal Boxoffice ($(date '+%d-%m-%Y %I:%M %p'))" || echo "No changes to commit"

        # ‚úÖ Retry logic: pull --rebase + push (max 3 times)
        for i in 1 2 3; do
          echo "üîÑ Attempt $i to pull --rebase & push..."
          if git pull --rebase && git push; then
            echo "‚úÖ Push success on attempt $i"
            break
          else
            echo "‚ö†Ô∏è Push failed on attempt $i"
            if [ "$i" -eq 3 ]; then
              echo "‚ùå Giving up after 3 attempts"
              exit 1
            fi
            sleep 10
          fi
        done

    # ‚ú®‚ú®‚ú® BUILT-IN MONGODB SYNC (DETAILED ONLY) ‚ú®‚ú®‚ú®
    - name: üì¶ Install MongoDB dependencies
      run: |
        pip install pymongo dnspython pytz

    - name: üîÑ Sync Nepal Detailed Data to MongoDB
      if: success()
      env:
        MONGODB_URI: ${{ secrets.MONGODB_URI }}
        MONGODB_DATABASE: ${{ secrets.MONGODB_DATABASE }}
      run: |
        python mongodb/sync_nepal.py

    - name: üìä Final Summary
      if: always()
      run: |
        echo "================================"
        echo "Nepal Boxoffice Workflow Complete"
        echo "================================"
        echo "Time: $(date +'%Y-%m-%d %H:%M IST')"
        echo "Status: ${{ job.status }}"